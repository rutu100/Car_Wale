{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ car.name }} | Car Hub{% endblock %}

{% block content %}
<div class="container py-4 fade-in">

<!-- ================= MESSAGES ================= -->
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} text-center w-50 mx-auto">
    {{ message }}
</div>
{% endfor %}
{% endif %}

<!-- ================= CAR DETAILS ================= -->
<div class="card shadow-lg border-0 mb-5 slide-up">
<div class="row g-0 align-items-center">

<!-- IMAGE -->
<div class="col-md-5 text-center p-4 zoom-img">
{% if car.image %}
<img src="{{ car.image.url }}"
     class="img-fluid rounded shadow-sm"
     alt="{{ car.name }}"
     loading="lazy">
{% else %}
<p class="text-muted">No image available</p>
{% endif %}
</div>

<!-- INFO -->
<div class="col-md-7">
<div class="card-body p-4">

<h2 class="fw-bold">{{ car.name }}</h2>

<span class="badge bg-primary me-2">{{ car.brand.name }}</span>
<span class="badge bg-success">Available</span>

<!-- ‚≠ê AVERAGE RATING -->
<div class="mt-2 text-warning">
    ‚òÖ {{ car.rating|floatformat:1 }} / 5
    <small class="text-muted">(Avg Rating)</small>
</div>

<p class="mt-3 text-muted">{{ car.description }}</p>

<!-- PRICE & STOCK -->
<div class="row mt-4">
    <div class="col-6">
        <small class="text-muted">Ex-showroom Price</small>
        <h4 class="text-success">‚Çπ {{ car.price }}</h4>
    </div>
    <div class="col-6">
        <small class="text-muted">Stock Available</small>
        <h5>{{ car.quantity }}</h5>
    </div>
</div>

<!-- ACTIONS -->
<div class="mt-4 d-flex gap-2 flex-wrap">

{% if user.is_authenticated %}
    {% if car.quantity > 0 %}
    <form method="post">
        {% csrf_token %}
        <button name="buy_now" class="btn btn-primary pulse">
            <i class="bi bi-cart-check"></i> Buy Now
        </button>
    </form>
    {% else %}
    <button class="btn btn-secondary" disabled>Out of Stock</button>
    {% endif %}

    {% if in_wishlist %}
    <a href="{% url 'remove_from_wishlist' car.id %}"
       class="btn btn-outline-danger">
       ‚ù§Ô∏è Remove Wishlist
    </a>
    {% else %}
    <a href="{% url 'add_to_wishlist' car.id %}"
       class="btn btn-outline-danger">
       ü§ç Add Wishlist
    </a>
    {% endif %}
{% else %}
<p>
<a href="{% url 'login' %}">Login</a> to buy or wishlist
</p>
{% endif %}
</div>

<!-- ‚≠ê USER RATING -->
{% if user.is_authenticated %}
<form method="post" action="{% url 'rate_car' car.id %}" class="mt-3">
    {% csrf_token %}
    <label class="fw-semibold">Rate this car</label>
    <div class="d-flex gap-2 align-items-center">
        <select name="rating" class="form-select w-auto">
            <option value="1">‚≠ê 1</option>
            <option value="2">‚≠ê‚≠ê 2</option>
            <option value="3">‚≠ê‚≠ê‚≠ê 3</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4</option>
            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</option>
        </select>
        <button class="btn btn-success btn-sm">
            Submit
        </button>
    </div>
</form>
{% endif %}

<!-- ADMIN -->
{% if user == car.author or user.is_superuser %}
<div class="mt-4 border-top pt-3">
<a href="{% url 'edit_car' car.id %}" class="btn btn-outline-warning btn-sm">
<i class="bi bi-pencil"></i> Edit
</a>
<a href="{% url 'delete_car' car.id %}"
   class="btn btn-outline-danger btn-sm"
   onclick="return confirm('Delete this car?')">
<i class="bi bi-trash"></i> Delete
</a>
</div>
{% endif %}

</div>
</div>
</div>
</div>

<!-- ================= SPECIFICATIONS ================= -->
<div class="card shadow-sm mb-4 slide-up">
<div class="card-body">
<h5 class="fw-bold mb-3">Key Specifications</h5>

<div class="row text-center">

    <div class="col-md-3 col-6 mb-3">
        <strong>{{ car.fuel_type }}</strong><br>
        <small class="text-muted">Fuel</small>
    </div>

    <div class="col-md-3 col-6 mb-3">
        <strong>{{ car.transmission }}</strong><br>
        <small class="text-muted">Transmission</small>
    </div>

    <div class="col-md-3 col-6 mb-3">
        <strong>{{ car.mileage }}</strong><br>
        <small class="text-muted">Mileage</small>
    </div>

    <div class="col-md-3 col-6 mb-3">
        <strong>{{ car.seating }} Seater</strong><br>
        <small class="text-muted">Seating</small>
    </div>

</div>
</div>
</div>

<!-- ================= COMMENTS ================= -->
<div class="card shadow-sm mb-4 slide-up">
<div class="card-body">
<h5 class="fw-bold mb-3">User Reviews ({{ comments|length }})</h5>

{% for comment in comments %}
<div class="border rounded p-3 mb-3 hover-box">
<strong>{{ comment.name }}</strong>
<small class="text-muted float-end">
{{ comment.created_on|date:"d M Y, H:i" }}
</small>
<p class="mt-2 mb-0">{{ comment.body }}</p>
</div>
{% empty %}
<p class="text-muted">No reviews yet.</p>
{% endfor %}
</div>
</div>

<!-- ================= ADD COMMENT ================= -->
<div class="card shadow-sm mb-5 slide-up">
<div class="card-body">
<h5 class="fw-bold mb-3">Write a Review</h5>

<form method="post">
{% csrf_token %}
{{ comment_form|crispy }}
<button name="comment" class="btn btn-warning mt-2">
<i class="bi bi-chat-dots"></i> Submit
</button>
</form>
</div>
</div>

</div>
{% endblock %}
