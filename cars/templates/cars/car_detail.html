{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}{{ car.name }} | Car Hub{% endblock %}

{% block content %}
<div class="container py-4">

<!-- ================= MESSAGES ================= -->
{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }} text-center w-50 mx-auto">
    {{ message }}
</div>
{% endfor %}
{% endif %}

<!-- ================= CAR DETAILS ================= -->
<div class="card shadow-lg border-0 mb-5">
<div class="row g-0 align-items-center">

<!-- IMAGE -->
<div class="col-md-5 text-center p-4">
{% if car.image %}
<img src="{{ car.image.url }}" class="img-fluid rounded shadow-sm">
{% else %}
<img src="{% static 'images/no-car.png' %}" class="img-fluid">
{% endif %}
</div>

<!-- INFO -->
<div class="col-md-7">
<div class="card-body p-4">

<h2 class="fw-bold">{{ car.name }}</h2>

<span class="badge bg-primary me-2">{{ car.brand.name }}</span>

{% if car.quantity > 0 %}
<span class="badge bg-success">Available</span>
{% else %}
<span class="badge bg-danger">Out of Stock</span>
{% endif %}

<!-- ‚≠ê RATING -->
<div class="mt-2 text-warning">
    ‚òÖ {{ car.rating|floatformat:1 }} / 5
</div>

<p class="mt-3 text-muted">{{ car.description }}</p>

<!-- PRICE -->
<div class="row mt-4">
    <div class="col-6">
        <small class="text-muted">Ex-showroom Price</small>
        <h4 class="text-success">‚Çπ {{ car.price }}</h4>
    </div>
    <div class="col-6">
        <small class="text-muted">On-road Price</small>
        <h5>‚Çπ {{ car.on_road_price }}</h5>
    </div>
</div>

<!-- ACTIONS -->
<div class="mt-4 d-flex gap-2 flex-wrap">
{% if user.is_authenticated %}
    {% if car.quantity > 0 %}
    <form method="post">
        {% csrf_token %}
       <button type="button"
        class="btn btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#paymentModal">
  Buy Now
</button>

    </form>
    {% endif %}
     <!-- üöó BOOK TEST DRIVE BUTTON (ADDED) -->
    <a href="{% url 'test_drive' %}?car={{ car.id }}"
       class="btn btn-outline-success">
       üöó Book Test Drive
    </a>

    {% if in_wishlist %}
    <a href="{% url 'remove_from_wishlist' car.id %}" class="btn btn-outline-danger">
        ‚ù§Ô∏è Remove Wishlist
    </a>
    {% else %}
    <a href="{% url 'add_to_wishlist' car.id %}" class="btn btn-outline-danger">
        ü§ç Add Wishlist
    </a>
    {% endif %}
{% else %}
<p><a href="{% url 'login' %}">Login</a> to continue</p>
{% endif %}
</div>

</div>
</div>
</div>
</div>

<!-- ================= SPECIFICATIONS ================= -->
<div class="card shadow-sm mb-4">
<div class="card-body">
<h5 class="fw-bold mb-3">Key Specifications</h5>

<div class="row text-center">

<div class="col-md-3 col-6 mb-3">
<strong>
{% for fuel in car.fuel_types.all %}
{{ fuel.name }}{% if not forloop.last %}, {% endif %}
{% endfor %}
</strong><br>
<small class="text-muted">Fuel</small>
</div>

<div class="col-md-3 col-6 mb-3">
<strong>{{ car.transmission }}</strong><br>
<small class="text-muted">Transmission</small>
</div>

<div class="col-md-3 col-6 mb-3">
<strong>{{ car.mileage }}</strong><br>
<small class="text-muted">Mileage</small>
</div>

<div class="col-md-3 col-6 mb-3">
<strong>{{ car.seating }} Seater</strong><br>
<small class="text-muted">Seating</small>
</div>

</div>
</div>
</div>

<!-- ================= COMMENTS ================= -->
<div class="card shadow-sm mb-4">
<div class="card-body">
<h5 class="fw-bold mb-3">User Reviews</h5>

{% for comment in comments %}
<div class="border rounded p-3 mb-3">
<strong>{{ comment.name }}</strong>
<small class="text-muted float-end">{{ comment.created_on|date:"d M Y" }}</small>
<p class="mt-2">{{ comment.body }}</p>
</div>
{% empty %}
<p class="text-muted">No reviews yet.</p>
{% endfor %}
</div>
</div>

<!-- ================= ADD COMMENT ================= -->
<div class="card shadow-sm mb-5">
<div class="card-body">
<h5 class="fw-bold mb-3">Write a Review</h5>

<form method="post">
{% csrf_token %}
{{ comment_form|crispy }}
<button name="comment" class="btn btn-warning mt-2">Submit</button>
</form>

</div>
</div>

</div>
{% endblock %}
